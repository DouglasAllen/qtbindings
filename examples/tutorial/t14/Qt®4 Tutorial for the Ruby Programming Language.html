<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<!-- saved from url=(0063)https://www.darshancomputing.com/qt4-qtruby-tutorial/chapter_14 -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en"><head profile="http://www.w3.org/2005/10/profile"><meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>Qt速4 Tutorial for the Ruby Programming Language</title>

<link rel="stylesheet" href="./Qt速4 Tutorial for the Ruby Programming Language_files/default.css" type="text/css">
<link rel="icon" type="image/png" href="https://www.darshancomputing.com/favicon.png">
<!-- google_ad_section_start(weight=ignore) -->
<link rel="start" href="https://www.darshancomputing.com/qt4-qtruby-tutorial/">
<link rel="prev" href="https://www.darshancomputing.com/qt4-qtruby-tutorial/chapter_13">
<!-- google_ad_section_end -->
</head>
<body>
<div class="page">
<!-- google_ad_section_start(weight=ignore) -->
<div class="navPrev">&nbsp;[Prev: <a href="https://www.darshancomputing.com/qt4-qtruby-tutorial/chapter_13">Chapter 13</a>]</div>
<div class="navContents">&nbsp;[<a href="https://www.darshancomputing.com/qt4-qtruby-tutorial/">Contents</a>]&nbsp;</div>
<div class="navNext">&nbsp;</div>
<!-- google_ad_section_end -->
<div class="content">
<h1 class="title">Qt<sup>速</sup>4 Tutorial for the Ruby <br>Programming Language</h1>
<!-- google_ad_section_start(weight=ignore) --><h2 class="subtitle">Chapter 14: Facing the Wall</h2><!-- google_ad_section_end -->
<div class="center"><img src="./Qt速4 Tutorial for the Ruby Programming Language_files/t14.png" alt="Screenshot: Facing the Wall" width="516" height="386"></div>
<br>
Files:
<ul>
<li><a href="https://www.darshancomputing.com/qt4-qtruby-tutorial/tutorial/t14/t14.rb">t14.rb</a></li>
<li><a href="https://www.darshancomputing.com/qt4-qtruby-tutorial/tutorial/t14/cannon.rb">cannon.rb</a></li>
<li><a href="https://www.darshancomputing.com/qt4-qtruby-tutorial/tutorial/t14/gamebrd.rb">gamebrd.rb</a></li>
<li><a href="https://www.darshancomputing.com/qt4-qtruby-tutorial/tutorial/t14/lcdrange.rb">lcdrange.rb</a></li>
</ul>
<h3>Overview</h3>

<p>
This is the final example: a complete game.
</p>

<p>
We add keyboard accelerators and introduce mouse events to 
<code>CannonField</code>. We put a frame around the <code>CannonField</code>
 and add a barrier (wall) to make the game more challenging.
</p>

<h3>Line by Line Walkthrough</h3>

<h4><a href="https://www.darshancomputing.com/qt4-qtruby-tutorial/tutorial/t14/cannon.rb">cannon.rb</a></h4>

<p>
The <code>CannonField</code> can now receive mouse events to make the user aim 
the barrel by clicking on it and dragging. 
<code>CannonField</code> also has a barrier wall.
</p>

<pre class="code">    @barrelPressed = false
</pre>

<p>
This line has been added to the constructor. 
Initially, the mouse is not pressed on the barrel.
</p>

<pre class="code">    elsif shotR.x() &gt; width() || shotR.y() &gt; height() ||
        shotR.intersects(barrierRect())
</pre>

<p>
Now that we have a barrier, there are three ways to miss. We test for the third, too.
(In <code>moveShot()</code>.)
</p>

<pre class="code">  def mousePressEvent(event)
    unless event.button() == Qt::LeftButton
      return
    end

    if barrelHit(event.pos())
      @barrelPressed = true
    end
  end
</pre>

<p>
This is a Qt event handler. It is called when the user presses a mouse button 
when the mouse cursor is over the widget.
</p>

<p>
If the event was not generated by the left mouse button, we return immediately. 
Otherwise, we check if the position of the mouse cursor is within the cannon's 
barrel. If it is, we set <code>barrelPressed</code> to true.
</p>

<p>
Notice that the <a href="http://doc.trolltech.com/4.2/qmouseevent.html#pos">Qt::MouseEvent::pos()</a> function returns a point in the widget's coordinate system.
</p>

<pre class="code">  def mouseMoveEvent(event)
    unless @barrelPressed
      return
    end

    pos = event.pos();

    if pos.x() &lt;= 0
      pos.setX(1)
    end

    if pos.y() &gt;= height()
      pos.setY(height() - 1)
    end

    rad = atan2((rect().bottom() - pos.y()), pos.x())
    setAngle((rad * 180 / 3.14159265).round())
  end
</pre>

<p>
This is another Qt event handler. It is called when the user already has 
pressed the mouse button inside this widget and then moves/drags the mouse. 
(You can make Qt send mouse move events even when no buttons are pressed. 
See <a href="http://doc.trolltech.com/4.2/qwidget.html#mouseTracking-prop">Qt::Widget::setMouseTracking()</a>.)
</p>

<p>
This handler repositions the cannon's barrel according to the position of the 
mouse cursor.
</p>

<p>
First, if the barrel is not pressed, we return. Next, we fetch the mouse 
cursor's position. If the mouse cursor is to the left or below the widget, 
we adjust the point to be inside the widget.
</p>

<p>
Then we calculate the angle between the bottom edge of the widget and the 
imaginary line between the bottom-left corner of the widget and the cursor position. 
Finally we set the cannon's angle to the new value converted to degrees.
</p>

<p>
Remember that <code>setAngle()</code> redraws the cannon.
</p>

<pre class="code">  def mouseReleaseEvent(event)
    if event.button() == Qt::LeftButton
      @barrelPressed = false
    end
  end
</pre>

<p>
This Qt event handler is called whenever the user releases a mouse button and 
it was pressed inside this widget.
</p>

<p>
If the left button is released, we can be sure that the barrel is no longer 
pressed.
</p>

<p>
The paint event has one extra line:
</p>

<pre class="code">    paintBarrier(painter)
</pre>

<p>
<code>paintBarrier()</code> does the same sort of thing as 
<code>paintShot()</code>, <code>paintTarget()</code>, and 
<code>paintCannon()</code>.
</p>

<pre class="code">  def paintBarrier( painter )
    painter.setBrush(Qt::Brush.new(Qt::yellow))
    painter.setPen(Qt::Color.new(Qt::black))
    painter.drawRect(barrierRect())
  end
</pre>

<p>
This function paints the barrier as a rectangle filled with yellow and with a 
black outline.
</p>

<pre class="code">  def barrierRect()
    return Qt::Rect.new(145, height() - 100, 15, 99)
  end
</pre>

<p>
This function returns the rectangle of the barrier. 
We fix the bottom edge of the barrier to the bottom edge of the widget.
</p>

<pre class="code">  def barrelHit(pos)
    matrix = Qt::Matrix.new()
    matrix.translate(0, height())
    matrix.rotate(-@currentAngle)
    matrix = matrix.inverted()
    return @barrelRect.contains(matrix.map(pos))
  end
</pre>

<p>
This function returns <code>true</code> if the point is in the barrel; 
otherwise it returns <code>false</code>.
</p>

<p>
Here we use the class <a href="http://doc.trolltech.com/4.2/qmatrix.html">Qt::Matrix</a>. <a href="http://doc.trolltech.com/4.2/qmatrix.html">Qt::Matrix</a> defines a coordinate system mapping. It can perform the same transformations as the <a href="http://doc.trolltech.com/4.2/qpainter.html">Qt::Painter</a>.
</p>

<p>
Here we perform the same transformation steps as we do when drawing the 
barrel in the <code>paintCannon()</code> function. 
First we translate the coordinate system and then we rotate it.
</p>

<p>
Now we need to check whether the point <code>pos</code> (in widget coordinates)
lies inside the barrel. To do this, we invert the transformation matrix. 
The inverted matrix performs the inverse transformation that we used when 
drawing the barrel. We map the point <code>pos</code> using the inverted matrix
and return <code>true</code> if it is inside the original barrel rectangle.
</p>

<h4><a href="https://www.darshancomputing.com/qt4-qtruby-tutorial/tutorial/t14/gamebrd.rb">gamebrd.rb</a></h4>

<pre class="code">    cannonBox = Qt::Frame.new()
    cannonBox.setFrameStyle(Qt::Frame::WinPanel | Qt::Frame::Sunken)
</pre>

<p>
We create and set up a <a href="http://doc.trolltech.com/4.2/qframe.html">Qt::Frame</a>, and set its frame style. 
This results in a 3D frame around the <code>CannonField</code>.
</p>

<pre class="code">    Qt::Shortcut.new(Qt::KeySequence.new(Qt::Key_Enter.to_i),
                     self, SLOT('fire()'))
    Qt::Shortcut.new(Qt::KeySequence.new(Qt::Key_Return.to_i),
                     self, SLOT('fire()'))
    Qt::Shortcut.new(Qt::KeySequence.new(Qt::CTRL.to_i + Qt::Key_Q.to_i),
                     self, SLOT('close()'))
</pre>

<p>
Here we create and set up three <a href="http://doc.trolltech.com/4.2/qshortcut.html">Qt::Shortcut</a> objects. These objects intercept 
keyboard events to a widget and call slots if certain keys are pressed. 
Note that a <a href="http://doc.trolltech.com/4.2/qshortcut.html">Qt::Shortcut</a> object is a child of a widget and will be destroyed when 
that widget is destroyed. <a href="http://doc.trolltech.com/4.2/qshortcut.html">Qt::Shortcut</a> itself is not a widget and has no visible 
effect on its parent.
</p>

<p>
We define three shortcut keys. We want the <code>fire()</code> slot to be 
called when the user presses Enter or Return. We also want the application to 
quit when key Ctrl+Q is pressed. Instead of connecting to 
<a href="http://doc.trolltech.com/4.2/qcoreapplication.html#quit">Qt::CoreApplication::quit()</a>, we connect to <a href="http://doc.trolltech.com/4.2/qwidget.html#close">Qt::Widget::close()</a> this time. Since the 
<code>GameBoard</code> is the application's main widget, this has the same 
effect as <a href="http://doc.trolltech.com/4.2/qcoreapplication.html#quit">QCoreApplication::quit()</a>.
</p>

<p>
Qt::CTRL, Qt::Key_Enter, Qt::Key_Return, and Qt::Key_Q are all constants 
declared in the Qt namespace.  Unfortunately, in the current version of qtruby,
they need to be converted to integers before we can use them in our shortcuts.
</p>

<pre class="code">    leftLayout = Qt::VBoxLayout.new()
    leftLayout.addWidget(angle)
    leftLayout.addWidget(force)

    gridLayout = Qt::GridLayout.new()
    gridLayout.addWidget(quit, 0, 0)
    gridLayout.addLayout(topLayout, 0, 1)
    gridLayout.addLayout(leftLayout, 1, 0)
    gridLayout.addWidget(@cannonField, 1, 1, 2, 1)
    gridLayout.setColumnStretch(1, 10)
    setLayout(gridLayout)
</pre>

<p>
We give <code>cannonBox</code> its own <a href="http://doc.trolltech.com/4.2/qvboxlayout.html">Qt::VBoxLayout</a>, and we add 
<code>cannonField</code> to that layout. This implicitly makes 
<code>cannonField</code> a child of <code>cannonBox</code>. Because nothing 
else is in the box, the effect is that the <a href="http://doc.trolltech.com/4.2/qvboxlayout.html">Qt::VBoxLayout</a> will put a frame around 
the <code>CannonField</code>. We put <code>cannonBox</code>, not 
<code>cannonField</code>, in the grid layout.
</p>

<h3>Running the Application</h3>

<p>
The cannon now shoots when you press Enter. You can also position the cannon's 
angle using the mouse. The barrier makes it a little more challenging to play 
the game. We also have a nice looking frame around the <code>CannonField</code>.
</p>

<!-- google_ad_section_start(weight=ignore) --><h3>Exercises</h3><!-- google_ad_section_end -->

<p>
Write a space invaders game.
</p>

<p>
(This exercise was first done by 
<a href="mailto:igorr@ifi.uio.no">Igor Rafienko</a>. You can 
<a href="http://heim.ifi.uio.no/~igorr/download.html">download his game</a>.)
</p>

<p>
The new exercise is: Write a Breakout game.
</p>

<p>
Final exhortation: Go forth now and create masterpieces of the programming art!
</p>
</div>
<!-- google_ad_section_start(weight=ignore) -->
<div class="navPrev">&nbsp;[Prev: <a href="https://www.darshancomputing.com/qt4-qtruby-tutorial/chapter_13">Chapter 13</a>]</div>
<div class="navContents">&nbsp;[<a href="https://www.darshancomputing.com/qt4-qtruby-tutorial/">Contents</a>]&nbsp;</div>
<div class="navNext">&nbsp;</div>
<!-- google_ad_section_end -->
<!-- google_ad_section_start(weight=ignore) -->
<hr><div class="legal_link"><a href="https://www.darshancomputing.com/qt4-qtruby-tutorial/legal">Legal Notice</a>&nbsp;</div>
<div class="contact_link"><a href="mailto:qt-tutorial@darshancomputing.com">Contact Me</a></div>
<!-- google_ad_section_end -->
<div class="force_clear"></div>
</div>

<p style="clear: both">
</p><p style="margin-bottom: 0px;">
  <a href="http://validator.w3.org/check?uri=referer"><img src="./Qt速4 Tutorial for the Ruby Programming Language_files/valid-xhtml10.png" alt="Valid XHTML 1.0!" height="31" width="88"></a>
  <a href="http://jigsaw.w3.org/css-validator/check/referer"><img src="./Qt速4 Tutorial for the Ruby Programming Language_files/vcss.png" alt="Valid CSS!" height="31" width="88"></a>
</p>

<p style="margin-top: 10px; margin-bottom: 0px;">
This page was last generated Sun Dec 03 14:40:27 -0800 2006
</p>
<script type="text/javascript">/* <![CDATA[ */(function(d,s,a,i,j,r,l,m,t){try{l=d.getElementsByTagName('a');t=d.createElement('textarea');for(i=0;l.length-i;i++){try{a=l[i].href;s=a.indexOf('/cdn-cgi/l/email-protection');m=a.length;if(a&&s>-1&&m>28){j=28+s;s='';if(j<m){r='0x'+a.substr(j,2)|0;for(j+=2;j<m&&a.charAt(j)!='X';j+=2)s+='%'+('0'+('0x'+a.substr(j,2)^r).toString(16)).slice(-2);j++;s=decodeURIComponent(s)+a.substr(j,m-j)}t.innerHTML=s.replace(/</g,'&lt;').replace(/>/g,'&gt;');l[i].href='mailto:'+t.value}}catch(e){}}}catch(e){}})(document);/* ]]> */</script>

</body></html>